angular.module("shopApp",["ngRoute"]).config(["$routeProvider","$locationProvider",function(e,t){e.when("/",{templateUrl:"pages/home.html",controller:"HomeCtrl"}).when("/users/reg",{templateUrl:"pages/user/reg.html",controller:"RegCtrl"}).when("/users/login",{templateUrl:"pages/user/login.html",controller:"LoginCtrl"}).when("/wares/admin/list",{templateUrl:"pages/ware/admin/list.html",controller:"WareCtrl"}).when("/wares/list",{templateUrl:"pages/ware/list.html",controller:"WareCtrl"}).when("/carts/list",{templateUrl:"pages/cart/list.html",controller:"CartCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("shopApp").run(["$rootScope","$location","$http",function(e,t,n){n({url:"/users/validate",method:"POST"}).success(function(n){e.me=n,t.path("/")}).error(function(e){t.path("/login")})}]),angular.module("shopApp").factory("dataService",["$http",function(e){var t={},n=["get","post"];return n.forEach(function(n){t[n]=function(t){var r={url:t,method:n.toUpperCase()},o=arguments[1],a=null;"function"==typeof o?a=o:r.data=o;var c=e(r);a||(a=arguments[2]),a&&"function"==typeof a&&c.success(a)}}),t}]),angular.module("shopApp").directive("selectItem",function(){return{link:function(e,t,n){t.on("click",function(){var t=$('input[name="chkItem"]:not(:checked)').length?!1:!0;$("#selectAll").prop("checked",t),e.calculate()})}}}),angular.module("shopApp").directive("selectAll",function(){return{link:function(e,t,n){t.on("click",function(){var t=$(this);$("input[type='checkbox']").each(function(){$(this).prop("checked",t.prop("checked"))}),e.calculate()})}}}),angular.module("shopApp").controller("WareCtrl",["$rootScope","$scope","$http","$location","fileReader","dataService",function(e,t,n,r,o,a){function c(e,t){var r=new FormData;angular.forEach(t,function(e,t){r.append(t,e)});var o={method:"POST",url:e,data:r,headers:{"Content-Type":void 0},transformRequest:angular.identity};return n(o)}t.keyword="",t.filterWares=[],t.pageNumber=1,t.pageSize=4,t.pages=[],t.wares=[],n({url:"/wares/list",method:"GET"}).success(function(e){t.wares=e,t.filter()}).error(function(){}),t.filter=function(){var e=t.wares.filter(function(e){return-1!=e.name.indexOf(t.keyword)});t.pages=[],t.totalPage=Math.ceil(e.length/t.pageSize);for(var n=1;n<=t.totalPage;n++)t.pages.push(n);e=e.filter(function(n,r){return r>=(t.pageNumber-1)*t.pageSize&&r<e.length&&r<t.pageNumber*t.pageSize}),t.filterWares=e},t.go=function(e){e>0&&e<=t.totalPage&&(t.pageNumber=e,t.filter())},t.getFile=function(){o.readAsDataUrl(t.file,t).then(function(e){t.ware.imgSrc=e})},t.save=function(){var e=c("/wares/add",t.ware);e.success(function(e){t.ware._id?t.wares.forEach(function(e){(e._id=t.ware._id)&&(e=t.ware)}):t.wares.push(e),console.log(t.wares),t.filter()}).error(function(){})},t["delete"]=function(){n({url:"/wares/delete",method:"POST",data:t.ware}).success(function(e){t.wares=t.wares.filter(function(e){return e._id!=t.ware._id}),t.filter()}).error(function(){})},t.addCart=function(e){a.post("/wares/addCart/"+e,function(){$("#addCartDoneDialog").modal(!0)})}}]),angular.module("shopApp").directive("addWares",function(){return{link:function(e,t,n){t.click(function(){$("#imgSrc").val(""),$("#imgPreview").prop("src",""),e.$apply(function(){e.ware={}}),$("#addDialog").modal(!0)})}}}),angular.module("shopApp").directive("viewWares",function(){return{link:function(e,t,n){t.click(function(){e.$apply(function(){e.$parent.ware=e.filterWares[n.index]}),$("#viewDialog").modal(!0)})}}}),angular.module("shopApp").directive("editWares",function(){return{link:function(e,t,n){t.click(function(){e.$apply(function(){e.$parent.ware=e.filterWares[n.index]}),$("#addDialog").modal(!0)})}}}),angular.module("shopApp").directive("deleteWares",function(){return{link:function(e,t,n){t.click(function(){e.$apply(function(){e.$parent.ware=e.filterWares[n.index]}),$("#deleteDialog").modal(!0)})}}}),angular.module("shopApp").directive("selectAllWares",function(){return{link:function(e,t,n){t.click(function(){var e=$(this);$("input[type='checkbox']").each(function(){$(this).prop("checked",e.prop("checked"))})})}}}),angular.module("shopApp").directive("selectWareItem",function(){return{link:function(e,t,n){t.click(function(){var e=$("input[type='checkbox']:not(:checked)").length?!1:!0;$("#selectAllWares").prop("checked",e)})}}}),angular.module("shopApp").directive("batchDeleteWares",["$http",function(e){return{link:function(t,n,r){n.click(function(){var n=$("input[type='checkbox']:checked"),r=[];n.each(function(e,t){r.push($(t).attr("data-id"))}),e({url:"/wares/batchDelete",method:"POST",data:{_ids:r}}).success(function(e){t.wares=t.wares.filter(function(e){return-1==r.indexOf(e._id)}),t.filter()}).error(function(){})})}}}]),angular.module("shopApp").directive("fileModel",["$parse",function(e){return{restrict:"A",link:function(e,t,n,r){t.bind("change",function(n){e.file=t[0].files[0],e.getFile()})}}}]),angular.module("shopApp").factory("fileReader",["$q",function(e){var t=function(e,t,n){return function(){n.$apply(function(){t.resolve(e.result)})}},n=function(e,t,n){return function(){n.$apply(function(){t.reject(e.result)})}},r=function(e,r){var o=new FileReader;return o.onload=t(o,e,r),o.onerror=n(o,e,r),o},o=function(t,n){var o=e.defer(),a=r(o,n);return a.readAsDataURL(t),o.promise};return{readAsDataUrl:o}}]),angular.module("shopApp").controller("RegCtrl",["$scope","$http","$location",function(e,t,n){e.user={},e.save=function(){t({url:"/users/reg",method:"POST",data:e.user}).success(function(e){n.path("/users/login")}).error(function(){n.path("/users/reg")})}}]),angular.module("shopApp").controller("NavBarCtrl",["$rootScope","$scope","$http","$location",function(e,t,n,r){t.logout=function(){n({url:"/users/logout",method:"POST"}).success(function(t){e.me=null,r.path("/login")}).error(function(){r.path("/login")})},t.isActive=function(e){return e==r.path()}}]),angular.module("shopApp").controller("LoginCtrl",["$rootScope","$scope","$http","$location",function(e,t,n,r){t.user={},t.login=function(){n({url:"/users/login",method:"POST",data:t.user}).success(function(t){e.me=t,r.path("/home")}).error(function(){r.path("/users/login")})}}]),angular.module("shopApp").controller("HomeCtrl",["$rootScope","$scope","$http","$location",function(e,t,n,r){t.title="欢迎光临珠峰网上商城"}]),angular.module("shopApp").controller("CartCtrl",["$scope","$http","$location","$timeout",function(e,t,n,r){e.carts=[],t({url:"/carts/list",method:"GET"}).success(function(t){e.carts=t,e.calculate()}).error(function(t){e.carts=[]}),e.calculate=function(){var e=0;$('input[name="chkItem"]:checked').each(function(){var t=$(this),n=t.attr("data-price"),r=parseInt(t.parent().parent().find("input:eq(1)").val());console.log(n,r),e+=n*r}),$("#total").html(e)},e.settle=function(){var n=[];$('input[name="chkItem"]:checked').each(function(){n.push($(this).data("id"))}),n.length?t({url:"/carts/settle",method:"POST",data:{_ids:n}}).success(function(t){e.carts=t,e.calculate()}).error(function(t){e.carts=[]}):$("#noSettleDialog").modal(!0)}}]),angular.module("shopApp").directive("changeQuantity",["$http",function(e){return{link:function(t,n,r){n.on("click",function(){var n=r.id,o=$(this).siblings("input"),a=parseInt(o.val())+parseInt(r.changeQuantity);a>0&&e({url:"/carts/changeQuantity",method:"POST",data:{_id:n,quantity:a}}).success(function(e){o.val(a),t.calculate()}).error(function(e){})})}}}]),angular.module("shopApp").directive("deleteCarts",["$http","$location","$timeout",function(e,t,n){return{link:function(t,r,o){r.on("click",function(){e({url:"/carts/del/"+o.id,method:"GET"}).success(function(e){t.$parent.carts=t.carts.filter(function(e){return e._id!=o.id}),n(function(){t.calculate()},100)}).error(function(e){})})}}}]),angular.module("shopApp").directive("batchDeleteCarts",["$http",function(e){return{link:function(t,n,r){n.click(function(){var n=$("input[type='checkbox']:checked"),r=[];n.each(function(){r.push($(this).attr("data-id"))}),console.log(r),e({url:"/carts/batchDelete",method:"POST",data:{_ids:r}}).success(function(e){t.carts=t.carts.filter(function(e){return-1==r.indexOf(e._id)})}).error(function(){})})}}}]);